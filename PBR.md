# __更详细的PBR⭐⭐⭐⭐⭐__

  ## [基于物理的渲染（PBR）白皮书（一） 开篇：PBR核心知识体系总结与概览 - 毛星云的文章](https://zhuanlan.zhihu.com/p/53086060)

  定义：基于物理的材质（Material）+基于物理的光照（Lighting）+基于物理的相机（Camera），而不仅仅是采用微平面cook-torrence的镜面反射

### __PBR在工业界的具体实现方法？https://zhuanlan.zhihu.com/p/420379757__
  
  答：一般分为两种工作流，分别是metallic-roughness和specular-glossiness。首先我们要知道，计算给定入射和观察方向的BRDF其实我们只需要知道几个量，分别是基础反射率R0或者说F0（用于描述菲涅尔项）、roughness（用于描述表面法线分布），以及表面的法线N（不是微表面法线）、入射光方向L、观察方向V。然后三个方向都是给定的，我们输入的贴图就是为了得到roughness和R0。
  * SG：首先diffuse就是直接计算漫反射项（漫反射下的BRDF视为一个常数），这部分不参与微表面BRDF的计算，然后后面的specular其实就是R0，Glossniess是1-roughnessgames104中提到的SG方式的具体代码
  * MR：MR其实就是在SG上面再套了一层壳，来让基础反射率R0不会因为一些不合理的设置导致出离谱的结果。MR首先给出一个basecolor，然后通过metalic去决定这个basecolor如何使用。下面给出的是M-R转S-G参数的代码。我们可以发现在计算高光分量的时候用了一个线性插值：也就是说，metalic即金属性，会决定有多少表面的基础颜色会被作为高光反射，如果是非金属绝缘体，那么高光反射的量其实是被锁死在一个非常小的值，也就是图中的dielectriSpecularColor。同时diffuse项则是金属性越低则越反射本身的颜色，金属本身其实不具有漫反射颜色。最后roughness就是roughness（吐槽一句这个convert函数里做了g=1-r，然后上面SG里面又把r=1-g，原地tp了属于是）

## __BRDF__
### __菲涅尔反射项与金属和绝缘体，次表面散射与漫反射__
  
  答：绝缘体的R0（基础反射率，或者说F0）比较低，金属的R0一般高于0.5。由于绝缘体一般不反射本身颜色，所以R0都是一个值（指RGB三通道都一样）。因此，绝缘体的高光反射不会反射出颜色，而金属高光反射会反射自身颜色。同时，金属表面几乎不存在漫反射。不同频率光谱的R0值不一样，所以金属的反射率会用RGB三通道表示。金属材质不会发生次表面反射，只用反射颜色（即反射出的金属光泽）。最后，半导体一般不会出现在渲染场景中，不考虑其反射率。

  基础反射率R0的含义即入射光和法线夹角为0时，高光反射为0，只反射材质本身颜色的情况。在入射光和法线夹角为90度时，完全反射入射光，所以菲涅尔项的计算就是R0和1.0的关于入射光夹角cos值的一个lerp。

  原始的菲涅尔方程其实还包含折射，但是cook-torrence 的brdf中的菲涅尔只考虑菲涅尔反射。如果要考虑半透明材质和次表面散射材质，需要使用BSDF\BTDF\BSSRDF这些BXDF模型。都是双向XX分布函数（BRDF是双向反射分布函数，即只考虑反射，这一部分推荐按照文章内渲染方程看）

  对于光的折射，也就是未被反射而进入表面内部的光的能量。对于金属来说，折射光的能量被自由电子立即吸收，也就是可以忽略折射光。对于绝缘体来说，一旦光在内部折射，就表现为常规的参与介质，表现出吸收和散射两种行为。而漫反射和次表面散射本质其实是相同的，本质都是折射光的次表面散射结果，区别在于观察尺度的散射距离，散射距离相较于像素来说微不足道，次表面散射可以近似为漫反射。如果像素范围大于散射光在平面上移动的距离，那么就可以直接当做漫反射进行计算，如果像素范围小于散射光移动距离，那么就需要当作次表面散射处理。如下图，左上图中，从绿框像素中入射的光线，其散射光也在这个像素内，也就可以视为所有最后散射出平面的光都在该像素上被反射，所以就是漫反射。而下图中像素入射的光线都在该像素以外的范围被反射出平面，所以就是次表面。

  所以我们可以知道，次表面散射的原理就是光进入物体内部散射之后，从表面上别的顶点（或者更细化到片元、像素）射出的情况。
  ![image](https://github.com/CHy-KK/Images/blob/main/SSS.png?raw=true)

### __漫反射与镜面反射__

  * diffuse BRDF：漫反射的经典模型就是lambert模型，即 漫反射光 = 光强I * 漫反射系数kd * dot(N,L)。
  
  * specular BRDF：我们常用的镜面反射BRDF是基于微平面理论的cook-torrencebrdf模型，即DFG公式。半程向量为视线v和入射方向i的中间向量

    D(h) 法线分布函数：常见模型包括：BlinnPhong，GGC、Beckmann等。接受半程向量作为输入，返回和半程向量h同一方向法线的概率（有多少法线分布在h方向）。
    F(l,h) 菲涅尔项：详细见上面，描述不同入射角度反射光线所占比例。接受入射光强和半程向量为输入，返回基础反射光（不是基础反射率）。由于只考虑半程向量，不考虑入射光水平方向上的角度，所以只适用于各向同性。
    G(l,v,h) 几何函数：描述微平面因为自遮挡产生的阴影，接受光强I，视角方向v，半程向量h为输入，返回当h=微观法线m时未被遮挡的表面点的百分比
    分母4(n·l)(n·v) 校正因子：矫正围观集合的局部空间和宏观表面局部空间变换的微平面量的矫正（不懂）需要注意的是，分母除了要clamp到[0,1]避免负值，还要加上一个很小的正量避免0。
  
## __环境光照__

  * diffuse：IBL中的辉度环境映射（Irradiance Environment Mapping），不属于物理特有方案不说
  * specular：采用重要性采样求解光亮度积分。
### __重要性采样的IBL__
这一部分其实也就属于specular的IBL。具体计算可以不用在意，最后结果=一张预过滤的环境贴图（模糊处理）*环境BRDF。

环境BRDF含义为镜面反射项的半球方向反射率。取决于观察方向和法线夹角θ，粗糙度α和菲涅尔项F。通常会将F单独提出来进行参数化，目前常用的有两种方案。
1. 2D LUT，由于我们将F提出来了，所以现在相当于只需要解决θ和α两个参数即可，所以我们将θ和α对最后结果的影响预计算到一张2D贴图中，最后BRDF的结果计算公式为：

    ```c#
    float3 LUT = TEXTURE2D(cosθ, α);
    brdf = F0 * LUT.r + LUT.g; 
    ```
2. 解析拟合，大概就是用一个近似公式进行计算，可以到文章中看，这里不贴出。
    
    